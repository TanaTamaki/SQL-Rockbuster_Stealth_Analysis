-- Finding the top 10 countries based on customer count:

SELECT  ctry.country,
		COUNT(customer_id) AS count_of_customers,
		ctry.country_id
FROM customer
INNER JOIN address ON customer.address_id = address.address_id
INNER JOIN city ON address.city_id = city.city_id
INNER JOIN country AS ctry ON city.country_id = ctry.country_id
GROUP BY ctry.country, ctry.country_id
ORDER BY COUNT(customer_id) DESC
LIMIT 10

-- Finding the top 10 cities in the top 10 countries based on customer count:

SELECT  cty.city,
		cty.city_id,
		ctry.country,
		ctry.country_id,
		COUNT(customer_id) AS count_of_customers
FROM customer
INNER JOIN address ON customer.address_id = address.address_id
INNER JOIN city AS cty ON address.city_id = cty.city_id
INNER JOIN country AS ctry ON cty.country_id = ctry.country_id
WHERE ctry.country_id IN (44, 23, 103, 50, 60, 15, 80, 75, 97, 45)
GROUP BY ctry.country, ctry.country_id, cty.city, cty.city_id
ORDER BY COUNT(customer_id) DESC
LIMIT 10

-- Finding the top 5 customers from the top 10 cities who've paid the highest amounts:

SELECT cust.customer_id,
		cust.first_name,
		cust.last_name, 
		cty.city, cty.city_id,
		ctry.country, ctry.country_id,
		SUM(amount) AS total_payment
FROM payment
INNER JOIN customer AS cust ON payment.customer_id = cust.customer_id
INNER JOIN address ON cust.address_id = address.address_id
INNER JOIN city AS cty ON address.city_id = cty.city_id
INNER JOIN country AS ctry ON cty.country_id = ctry.country_id
WHERE cty.city_id IN (42, 317, 106, 187, 283, 257, 205, 557, 310, 418)
GROUP BY cust.customer_id,cust.first_name,cust.last_name,cty.city,cty.city_id,ctry.country,ctry.country_id
ORDER BY (total_payment) DESC
LIMIT 5

-- (subquery) Finding the average amount paid by the top 5 customers:

SELECT AVG(total_payment) AS avg_total_payment
FROM 
(SELECT cust.customer_id,
		cust.first_name,
		cust.last_name, 
		cty.city, cty.city_id,
		ctry.country, ctry.country_id,
		SUM(amount) AS total_payment
FROM payment
INNER JOIN customer AS cust ON payment.customer_id = cust.customer_id
INNER JOIN address ON cust.address_id = address.address_id
INNER JOIN city AS cty ON address.city_id = cty.city_id
INNER JOIN country AS ctry ON cty.country_id = ctry.country_id
WHERE cty.city_id IN (42, 317, 106, 187, 283, 257, 205, 557, 310, 418)
GROUP BY cust.customer_id,cust.first_name,cust.last_name,cty.city,cty.city_id,ctry.country,ctry.country_id
ORDER BY (total_payment) DESC
LIMIT 5) AS average

-- (subquery) Finding how many of the top 5 customers are based in each country:

SELECT  COUNT (DISTINCT custA.customer_id) AS all_customer_count,
		COUNT (DISTINCT top_five_customers.customer_id) AS top_customer_count,
		ctryA.country, ctryA.country_id
FROM customer AS custA
INNER JOIN address AS addA ON custA.address_id = addA.address_id
INNER JOIN city AS ctyA ON addA.city_id = ctyA.city_id
INNER JOIN country AS ctryA ON ctyA.country_id = ctryA.country_id
LEFT JOIN 
(SELECT cust.customer_id,
		cust.first_name,
		cust.last_name, 
		cty.city, cty.city_id,
		ctry.country, ctry.country_id,
		SUM(amount) AS total_payment
FROM payment
INNER JOIN customer AS cust ON payment.customer_id = cust.customer_id
INNER JOIN address ON cust.address_id = address.address_id
INNER JOIN city AS cty ON address.city_id = cty.city_id
INNER JOIN country AS ctry ON cty.country_id = ctry.country_id
WHERE cty.city_id IN (42, 317, 106, 187, 283, 257, 205, 557, 310, 418)
GROUP BY cust.customer_id,cust.first_name,cust.last_name,cty.city,cty.city_id,ctry.country,ctry.country_id
ORDER BY (total_payment) DESC
LIMIT 5) AS top_five_customers ON top_five_customers.country = ctryA.country
GROUP BY ctryA.country, ctryA.country_id
HAVING COUNT (DISTINCT top_five_customers.customer_id) > 0
ORDER BY top_customer_count DESC, all_customer_count DESC



-- Using CTEs 

-- Finding the average amount paid by the top 5 customers:

WITH top_five_customers_total_payment AS (
    SELECT cust.customer_id,
           cust.first_name,
           cust.last_name, 
           cty.city, 
           cty.city_id,
           ctry.country, 
           ctry.country_id,
           SUM(amount) AS total_payment
FROM payment
INNER JOIN customer AS cust ON payment.customer_id = cust.customer_id
INNER JOIN address ON cust.address_id = address.address_id
INNER JOIN city AS cty ON address.city_id = cty.city_id
INNER JOIN country AS ctry ON cty.country_id = ctry.country_id
WHERE cty.city_id IN (42, 317, 106, 187, 283, 257, 205, 557, 310, 418)
GROUP BY cust.customer_id, cust.first_name, cust.last_name, cty.city, cty.city_id, ctry.country, ctry.country_id
ORDER BY (total_payment) DESC
LIMIT 5)

SELECT AVG (total_payment) AS avg_total_payment
FROM top_five_customers_total_payment;

-- Finding how many of the top 5 customers are based in each country:

WITH top_five_customers_total_payment AS (
    SELECT cust.customer_id,
           cust.first_name,
           cust.last_name, 
           cty.city, 
           cty.city_id,
           ctry.country, 
           ctry.country_id,
           SUM(amount) AS total_payment
FROM payment
INNER JOIN customer AS cust ON payment.customer_id = cust.customer_id
INNER JOIN address ON cust.address_id = address.address_id
INNER JOIN city AS cty ON address.city_id = city.city_id
INNER JOIN country AS ctry ON cty.country_id = ctry.country_id
WHERE cty.city_id IN (42, 317, 106, 187, 283, 257, 205, 557, 310, 418)
GROUP BY cust.customer_id, cust.first_name, cust.last_name, cty.city, cty.city_id, ctry.country, ctry.country_id
ORDER BY (total_payment) DESC
LIMIT 5)

SELECT  COUNT (DISTINCT custA.customer_id) AS all_customer_count,
        COUNT (DISTINCT top_five_customers_in_countries.customer_id) AS top_customer_count,
        ctryA.country,
        ctryA.country_id
FROM customer AS custA
INNER JOIN address AS addA ON custA.address_id = addA.address_id
INNER JOIN city AS ctyA ON addA.city_id = ctyA.city_id
INNER JOIN country AS ctryA ON ctyA.country_id = ctryA.country_id
LEFT JOIN top_five_customers_in_countries ON top_five_customers_in_countries.country = ctryA.country
GROUP BY ctryA.country, ctryA.country_id
ORDER BY top_customer_count DESC, all_customer_count DESC
LIMIT 5;
